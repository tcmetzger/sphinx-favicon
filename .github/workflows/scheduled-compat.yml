name: Scheduled compatibility check

on:
  schedule:
    # At 09:00 UTC on the 1st day every 2nd month
    - cron: "0 9 1 */2 *"
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  latest-compat:
    name: Latest supported deps on Python 3.13
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install tooling
        run: |
          python -m pip install --upgrade pip
          pip install nox

      - name: Run tests via nox
        id: tests
        run: |
          nox -s test -- --color=yes --cov --cov-report=xml

      - name: Open or update issue on failure
        if: failure()
        uses: actions/github-script@v7
        env:
          PY_VER: ${{ steps.tests.outputs.python }}
          SPHINX_VER: ${{ steps.tests.outputs.sphinx }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        with:
          script: |
            const title = 'Scheduled compatibility check failed';
            const body = `The scheduled CI run detected a failure with the latest supported dependencies.\n\n- Python: ${process.env.PY_VER}\n- Sphinx: ${process.env.SPHINX_VER}\n- Run: ${process.env.RUN_URL}\n\nPlease investigate and update compatibility as needed.`;
            const { owner, repo } = context.repo;
            const search = await github.rest.search.issuesAndPullRequests({
              q: `repo:${owner}/${repo} is:issue is:open in:title "${title}"`,
            });
            if (search.data.total_count > 0) {
              const issue = search.data.items[0];
              await github.rest.issues.createComment({ owner, repo, issue_number: issue.number, body });
            } else {
              await github.rest.issues.create({ owner, repo, title, body });
            }
